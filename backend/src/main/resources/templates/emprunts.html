<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Emprunts</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="/css/emprunts.css">
</head>
<body>
<nav id="sidebar">
    <h3 class="text-center"><img src="/images/library.png" alt="Icon" style="width: 40px; height: 40px; margin-right: 10px;">MyLibrary</h3>
    <ul class="nav flex-column">
        <li class="nav-item">
            <a class="nav-link" href="livres"><img src="/images/books.png" class="icons" alt="Icon" style="width: 25px; height: 25px; margin-right: 10px; margin-top: 10px">Livres</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="categories"><img src="/images/category.png" class="icons" alt="Icon" style="width: 25px; height: 25px; margin-right: 10px; margin-top: 10px">Catégories</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="emprunts"><img src="/images/emprunts.png" class="icons" alt="Icon" style="width: 25px; height: 25px; margin-right: 10px; margin-top: 10px">emprunts</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="facturations"><img src="/images/facture.png" class="icons" alt="Icon" style="width: 25px; height: 25px; margin-right: 10px; margin-top: 10px">Facturation</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="users"><img src="/images/users.png" class="icons" alt="Icon" style="width: 25px; height: 25px; margin-right: 10px; margin-top: 10px">Utilisateurs</a>
        </li>
        <li class="nav-item">
            <a class="nav-link-lougout" href="login" onclick="logout()"><img src="/images/logout.png" class="icons" alt="Icon" style="width: 25px; height: 25px; margin-right: 10px; margin-top: 10px">Déconnexion</a>
        </li>
    </ul>
</nav>

<div id="main-content">
    <div class="container mt-5">
        <h1 class="text-center mb-4">Gestion des Emprunts</h1>

        <!-- Liste des Emprunts -->
        <h2>Liste des Emprunts</h2>
        <table class="table table-striped" id="empruntsTable">
            <thead>
            <tr>
                <th>ID</th>
                <th>Utilisateur</th>
                <th>Livre</th>
                <th>Date d'Emprunt</th>
                <th>Date de Retour</th>
                <th>Statut</th>
                <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            <!-- Dynamic rows will be added here -->
            </tbody>
        </table>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('authToken');
        if (!token) {
            alert('Vous devez vous connecter pour accéder à cette page.');
            window.location.href = '/admin/login';
            return;
        }

        axios.interceptors.request.use(config => {
            config.headers.Authorization = `Bearer ${token}`;
            return config;
        }, error => Promise.reject(error));

        const empruntsTable = document.querySelector('#empruntsTable tbody');

        // Fetch all emprunts
        axios.get('/api/emprunts')
            .then(response => {
                empruntsTable.innerHTML = '';
                response.data.forEach(emprunt => {
                    const row = `<tr>
                            <td>${emprunt.id}</td>
                            <td>${emprunt.user.fullName} (${emprunt.user.email})</td>
                            <td>${emprunt.livre.titre}</td>
                            <td>${new Date(emprunt.dateEmprunt).toLocaleDateString()}</td>
                            <td>${emprunt.dateRetour ? new Date(emprunt.dateRetour).toLocaleDateString() : 'N/A'}</td>
                            <td>${emprunt.status}</td>
                            <td>
                                <button class="btn btn-primary btn-sm" onclick="updateStatus(${emprunt.id})">Modifier Statut</button>
                            </td>
                        </tr>`;
                    empruntsTable.innerHTML += row;
                });
            })
            .catch(error => console.error(error));
    });

    // Update the status of an emprunt
    function updateStatus(empruntId) {
        const newStatus = prompt('Entrez le nouveau statut (e.g., borrowed, returned):');
        if (newStatus) {
            axios.patch(`/api/emprunts/${empruntId}/status?status=${newStatus}`)
                .then(() => {
                    alert('Statut mis à jour avec succès!');
                    location.reload();
                })
                .catch(error => console.error(error));
        }
    }

    // Logout function
    function logout() {
        localStorage.removeItem('authToken');
        window.location.href = '/admin/login';
    }
</script>
</body>
</html>
