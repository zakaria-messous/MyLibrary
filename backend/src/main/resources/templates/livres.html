<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Livres</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/livres.css">
</head>
<body>
<nav id="sidebar">
    <h3 class="text-center"><img src="/images/library.png" alt="Icon" style="width: 40px; height: 40px; margin-right: 10px;">MyLibrary</h3>
    <ul class="nav flex-column">
        <li class="nav-item">
            <a class="nav-link" href="livres"><img src="/images/books.png" class="icons" alt="Icon" style="width: 25px; height: 25px; margin-right: 10px; margin-top: 10px">Livres</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="categories"><img src="/images/category.png" class="icons" alt="Icon" style="width: 25px; height: 25px; margin-right: 10px; margin-top: 10px">Catégories</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="emprunts"><img src="/images/emprunts.png" class="icons" alt="Icon" style="width: 25px; height: 25px; margin-right: 10px; margin-top: 10px">emprunts</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="facturations"><img src="/images/facture.png" class="icons" alt="Icon" style="width: 25px; height: 25px; margin-right: 10px; margin-top: 10px">Facturation</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="users"><img src="/images/users.png" class="icons" alt="Icon" style="width: 25px; height: 25px; margin-right: 10px; margin-top: 10px">Utilisateurs</a>
        </li>
        <li class="nav-item">
            <a class="nav-link-lougout" href="login" onclick="logout()"><img src="/images/logout.png" class="icons" alt="Icon" style="width: 25px; height: 25px; margin-right: 10px; margin-top: 10px">Déconnexion</a>
        </li>
    </ul>
</nav>

<div id="main-content">
    <div class="container mt-5">
        <h1 class="text-center mb-4">Gestion des Livres</h1>

        <!-- Ajouter un livre -->
        <div class="mb-5">
            <h2>Ajouter un Livre</h2>
            <form id="addLivreForm" class="row g-3">
                <div class="col-md-6">
                    <input type="text" id="titre" placeholder="Titre" class="form-control" required>
                </div>
                <div class="col-md-6">
                    <input type="text" id="auteur" placeholder="Auteur" class="form-control" required>
                </div>
                <div class="col-md-6">
                    <input type="text" id="description" placeholder="Description" class="form-control">
                </div>
                <div class="col-md-6">
                    <input type="number" id="nombreCopieDispo" placeholder="Nombre de Copies Disponibles" class="form-control">
                </div>
                <div class="col-md-6">
                    <input type="number" step="0.01" id="prix" placeholder="Prix" class="form-control">
                </div>
                <div class="col-md-6">
                    <select id="disponibilite" class="form-select">
                        <option value="true" selected>Disponible</option>
                        <option value="false">Indisponible</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <select id="categorie" class="form-select" required>
                        <option value="" selected disabled>Choisir une catégorie</option>
                    </select>
                </div>
                <div class="col-md-12">
                    <input type="text" id="imageUrl" placeholder="Lien de l'image" class="form-control">
                </div>
                <div class="col-md-6">
                    <button type="submit" class="btn btn-success w-100">Ajouter</button>
                </div>
            </form>
        </div>

        <!-- Liste des livres -->
        <div class="mb-5">
            <h2>Liste des Livres</h2>
            <button class="btn btn-primary mb-3" id="fetchAll">Afficher tous les livres</button>
            <table class="table table-striped text-center" id="livresTable">
                <thead>
                <tr>
                    <th>Book</th>
                    <th>Titre</th>
                    <th>Auteur</th>
                    <th>Description</th>
                    <th>Disponibilité</th>
                    <th>Copies</th>
                    <th>Prix</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                <!-- Les lignes seront ajoutées dynamiquement -->
                </tbody>
            </table>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
    // Vérifier l'authentification
    document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('authToken');
        if (!token) {
            alert('Vous devez vous connecter pour accéder à cette page.');
            window.location.href = '/admin/login';
            return;
        }

        // Add the token to Axios headers
        axios.interceptors.request.use(config => {
            config.headers.Authorization = `Bearer ${token}`;
            return config;
        });
    });


    // Injecter le token dans toutes les requêtes Axios
    axios.interceptors.request.use(config => {
        const token = localStorage.getItem('authToken');
        if (token) {
            config.headers.Authorization = `Bearer ${token}`;
        }
        return config;
    }, error => {
        return Promise.reject(error);
    });

    // Déconnexion
    function logout() {
        localStorage.removeItem('authToken');
        window.location.href = 'login';
    }

    // Fetch and populate categories
    document.addEventListener('DOMContentLoaded', () => {
        axios.get('/categorie')
            .then(response => {
                const categoriesDropdown = document.getElementById('categorie');
                response.data.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.nomCategorie; // Use category name as the value
                    option.textContent = category.nomCategorie; // Display the category name
                    categoriesDropdown.appendChild(option);
                });
            })
            .catch(error => console.error('Error fetching categories:', error));
    });


    // Ajouter un livre
    document.getElementById('addLivreForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const titre = document.getElementById('titre').value;
        const auteur = document.getElementById('auteur').value;
        const description = document.getElementById('description').value;
        const nombreCopieDispo = document.getElementById('nombreCopieDispo').value;
        const prix = document.getElementById('prix').value;
        const disponibilite = document.getElementById('disponibilite').value;
        const imageUrl = document.getElementById('imageUrl').value;
        const categorie = document.getElementById('categorie').value; // Get selected category name

        axios.post('/livre', {
            titre,
            auteur,
            description,
            nombreCopieDispo: parseInt(nombreCopieDispo),
            prix: parseFloat(prix),
            disponibilite: disponibilite === "true",
            imageUrl,
            categorie: { nomCategorie: categorie } // Send nomCategorie in the payload
        })
            .then(() => {
                alert('Livre ajouté avec succès !');
                document.getElementById('addLivreForm').reset();
                document.getElementById('fetchAll').click(); // Actualiser la liste
            })
            .catch(error => console.error(error));
    });


    // Afficher tous les livres
    document.getElementById('fetchAll').addEventListener('click', () => {
        axios.get('/livre')
            .then(response => {
                const tbody = document.querySelector('#livresTable tbody');
                tbody.innerHTML = '';
                response.data.forEach(livre => {
                    const row = `<tr>
                            <td><img src="${livre.imageUrl}" alt="Image de ${livre.titre}" class="img-thumbnail" style="width: 100px;"></td>
                            <td>${livre.titre}</td>
                            <td>${livre.auteur}</td>
                            <td>${livre.description || ''}</td>
                            <td>${livre.disponibilite ? 'Oui' : 'Non'}</td>
                            <td>${livre.nombreCopieDispo}</td>
                            <td>${livre.prix.toFixed(2)} €</td>
                            <td>
                                <button class="btn btn-success btn-sm" onclick="editLivre(${livre.id})">Modifier</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteLivre(${livre.id})">Supprimer</button>
                            </td>
                        </tr>`;
                    tbody.innerHTML += row;
                });
            })
            .catch(error => console.error(error));
    });

    // Modifier un livre
    function editLivre(id) {
        const newTitle = prompt('Entrez le nouveau titre:');
        const newAuthor = prompt('Entrez le nouveau auteur:');
        if (newTitle && newAuthor) {
            axios.put(`/livre/${id}`, { titre: newTitle, auteur: newAuthor })
                .then(() => {
                    alert('Livre modifié avec succès !');
                    document.getElementById('fetchAll').click(); // Refresh the list
                })
                .catch(error => console.error(error));
        }
    }

    // Supprimer un livre
    function deleteLivre(id) {
        if (confirm('Voulez-vous vraiment supprimer ce livre ?')) {
            axios.delete(`/livre/${id}`)
                .then(() => {
                    alert('Livre supprimé avec succès !');
                    document.getElementById('fetchAll').click(); // Refresh the list
                })
                .catch(error => console.error(error));
        }
    }

    // Acheter un livre
    function buyLivre(id) {
        axios.post(`/livre/buy/${id}`)
            .then(() => {
                alert('Livre acheté avec succès !');
            })
            .catch(error => console.error(error));
    }
</script>
</body>
</html>
