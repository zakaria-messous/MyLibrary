<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Utilisateurs</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="/css/users.css">
</head>
<body>
<nav id="sidebar">
    <h3 class="text-center"><img src="/images/library.png" alt="Icon" style="width: 40px; height: 40px; margin-right: 10px;">MyLibrary</h3>
    <ul class="nav flex-column">
        <li class="nav-item">
            <a class="nav-link" href="livres"><img src="/images/books.png" class="icons" alt="Icon" style="width: 25px; height: 25px; margin-right: 10px; margin-top: 10px">Livres</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="categories"><img src="/images/category.png" class="icons" alt="Icon" style="width: 25px; height: 25px; margin-right: 10px; margin-top: 10px">Catégories</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="emprunts"><img src="/images/emprunts.png" class="icons" alt="Icon" style="width: 25px; height: 25px; margin-right: 10px; margin-top: 10px">emprunts</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="facturations"><img src="/images/facture.png" class="icons" alt="Icon" style="width: 25px; height: 25px; margin-right: 10px; margin-top: 10px">Facturation</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="users"><img src="/images/users.png" class="icons" alt="Icon" style="width: 25px; height: 25px; margin-right: 10px; margin-top: 10px">Utilisateurs</a>
        </li>
        <li class="nav-item">
            <a class="nav-link-lougout" href="login" onclick="logout()"><img src="/images/logout.png" class="icons" alt="Icon" style="width: 25px; height: 25px; margin-right: 10px; margin-top: 10px">Déconnexion</a>
        </li>
    </ul>
</nav>

<div id="main-content">
    <div class="container mt-5">
        <h1 class="text-center mb-4">Gestion des Utilisateurs</h1>

        <!-- Ajouter un utilisateur -->
        <div class="mb-5">
            <h2>Ajouter un Utilisateur</h2>
            <form id="addUserForm" class="row g-3">
                <div class="col-md-4">
                    <input type="text" id="fullName" placeholder="Nom Complet" class="form-control" required>
                </div>
                <div class="col-md-4">
                    <input type="email" id="email" placeholder="Email" class="form-control" required>
                </div>
                <div class="col-md-4">
                    <input type="password" id="password" placeholder="Mot de Passe" class="form-control" required>
                </div>
                <div class="col-md-4">
                    <select id="role" class="form-select" required>
                        <option value="" disabled selected>Rôle</option>
                        <option value="USER">Utilisateur</option>
                        <option value="ADMIN">Administrateur</option>
                        <option value="SUPERADMIN">Super Administrateur</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-success w-100">Ajouter</button>
                </div>
            </form>
        </div>

        <!-- Liste des utilisateurs -->
        <div class="mb-5">
            <h2>Liste des Utilisateurs</h2>
            <button class="btn btn-primary mb-3" id="fetchAllUsers">Afficher tous les Utilisateurs</button>
            <table class="table table-striped" id="usersTable">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Nom Complet</th>
                    <th>Email</th>
                    <th>Rôle</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody>
                <!-- Les lignes seront ajoutées dynamiquement -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('authToken');
        if (!token) {
            alert('Vous devez vous connecter pour accéder à cette page.');
            window.location.href = '/admin/login';
            return;
        }

        // Injecter le token dans toutes les requêtes Axios
        axios.interceptors.request.use(config => {
            config.headers.Authorization = `Bearer ${token}`;
            return config;
        }, error => {
            return Promise.reject(error);
        });

        const usersTable = document.querySelector('#usersTable tbody');

        // Fetch all users
        document.getElementById('fetchAllUsers').addEventListener('click', () => {
            axios.get('/api/v1/admin/userlist')
                .then(response => {
                    usersTable.innerHTML = '';
                    response.data.forEach(user => {
                        const row = `<tr>
                                <td>${user.id}</td>
                                <td>${user.fullName}</td>
                                <td>${user.email}</td>
                                <td>${user.role}</td>
                                <td>
                                    <button class="btn btn-success btn-sm" onclick="editUser(${user.id})">Modifier</button>
                                    <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">Supprimer</button>
                                </td>
                            </tr>`;
                        usersTable.innerHTML += row;
                    });
                })
                .catch(error => console.error(error));
        });

        // Add a new user
        document.getElementById('addUserForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const fullName = document.getElementById('fullName').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const role = document.getElementById('role').value;

            axios.post('/api/v1/admin/createuser', { fullName, email, password, role })
                .then(() => {
                    alert('Utilisateur ajouté avec succès !');
                    document.getElementById('addUserForm').reset();
                    document.getElementById('fetchAllUsers').click(); // Refresh the list
                })
                .catch(error => console.error(error));
        });

        // Edit a user
        window.editUser = (id) => {
            const newFullName = prompt('Entrez le nouveau nom complet de l\'utilisateur:');
            const newRole = prompt('Entrez le nouveau rôle de l\'utilisateur (USER, ADMIN, SUPERADMIN):');
            if (newFullName && newRole) {
                axios.put(`/api/v1/admin/updateuser/${id}`, { fullName: newFullName, role: newRole })
                    .then(() => {
                        alert('Utilisateur modifié avec succès !');
                        document.getElementById('fetchAllUsers').click(); // Refresh the list
                    })
                    .catch(error => console.error(error));
            }
        };

        // Delete a user
        window.deleteUser = (id) => {
            if (confirm('Voulez-vous vraiment supprimer cet utilisateur ?')) {
                axios.delete(`/api/v1/admin/deleteuser/${id}`)
                    .then(() => {
                        alert('Utilisateur supprimé avec succès !');
                        document.getElementById('fetchAllUsers').click(); // Refresh the list
                    })
                    .catch(error => console.error(error));
            }
        };
    });
</script>
</body>
</html>
